<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Image filter - Sequential Workflow Designer</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<script src="../designer.js"></script>
	<link href="../designer.css" rel="stylesheet">

	<style>
		body {font: 14px/1.3em 'Open Sans', Arial, Verdana, Serif;}
		html, body {width: 100vw; height: 100vh; margin: 0; padding: 0; overflow: hidden;}
		#designer {position: absolute; left: 0; top: 0; width: 100vw; height: 50vh;}
		#result {position: absolute; left: 0; bottom: 0; width: 100vw; height: 50vh; display: flex; align-items: center;}
		#preview {margin: 0 auto;}
	</style>
</head>
<body>
	<div id="designer"></div>

	<div id="result">
		<canvas id="preview"></canvas>
	</div>

	<script>
		function loadImage(url) {
			return new Promise(resolve => {
				const image = new Image();
				image.onload = () => {
					resolve(image);
				};
				image.src = url;
			});
		}

		function grayscaleImage(d) {
			for (let i = 0; i < d.length; i += 4) {
				const c = Math.floor((d[i] + d[i + 1] + d[i + 2]) / 3);
				d[i] = c;
				d[i + 1] = c;
				d[i + 2] = c;
			}
		}

		function reverseColor(d) {
			for (let i = 0; i < d.length; i += 4) {
				d[i] = 255 - d[i];
				d[i + 1] = 255 - d[i + 1];
				d[i + 2] = 255 - d[i + 2];
			}
		}

		function contrast(d, contrast) {
			const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
			for (let i = 0; i < d.length; i += 4) {
				d[i] = factor * (d[i] - 128) + 128;
				d[i + 1] = factor * (d[i + 1] - 128) + 128;
				d[i + 2] = factor * (d[i + 2] - 128) + 128;
			}
		}

		function shiftColor(d) {
			for (let i = 0; i < d.length; i += 4) {
				const c = d[i];
				d[i] = d[i + 1];
				d[i + 1] = d[i + 2];
				d[i + 2] = c;
			}
		}

		async function renderImage(definition) {
			const canvas = document.getElementById('preview');
			const context = canvas.getContext('2d');

			const image = await loadImage('./assets/image-bee.jpg');

			canvas.width = image.width;
			canvas.height = image.height;
			context.drawImage(image, 0, 0);
			const imageData = context.getImageData(0, 0, image.width, image.height);

			definition.sequence.steps.forEach(step => {
				switch (step.type) {
					case 'grayscale':
						grayscaleImage(imageData.data);
						break;
					case 'reverse-color':
						reverseColor(imageData.data);
						break;
					case 'contrast':
						contrast(imageData.data, 50);
						break;
					case 'shift-color':
						shiftColor(imageData.data);
						break;
				}
			});

			context.putImageData(imageData, 0, 0);
		}

		function task(type, name) {
			return {
				id: '0x0',
				componentType: 'task',
				type,
				name,
				properties: {}
			};
		}

		const configuration = {
			toolbox: {
				isHidden: false,
				groups: [
					{
						name: 'Filters',
						steps: [
							task('grayscale', 'Grayscale'),
							task('reverse-color', 'Reverse color'),
							task('contrast', 'Contrast'),
							task('shift-color', 'Shift color')
						]
					}
				]
			},

			steps: {
				iconUrlProvider: (componentType, type) => {
					return `./assets/icon-filter.svg`
				},

				validator: (step) => true
			},

			editors: {
				isHidden: true,
				globalEditorProvider: (definition) => {},
				stepEditorProvider: (step) => {}
			}
		};

		const definition = {
			properties: {},
			sequence: {
				steps: [
					task('contrast', 'Contrast')
				]
			}
		};

		const placeholder = document.getElementById('designer');
		const designer = window.sequentialWorkflowDesigner.create(placeholder, definition, configuration);
		designer.onDefinitionChanged.subscribe(() => {
			renderImage(definition);
		});
		renderImage(definition);
	</script>
</body>
</html>

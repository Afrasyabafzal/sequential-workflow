<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Workflow - Sequential Workflow Designer</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<script src="../designer.js"></script>
	<link href="../designer.css" rel="stylesheet">

	<style>
		body {font: 14px/1.3em 'Open Sans', Arial, Verdana, Serif;}
		html, body {width: 100vw; height: 100vh; margin: 0; padding: 0; overflow: hidden;}
		#designer {position: absolute; left: 0; top: 0; width: 70vw; height: 100vh;}
		#result {position: absolute; right: 0; bottom: 0; width: 30vw; height: 100vh; background: silver;}
		#preview {margin: 0 auto;}
		.sqd-global-editor, .sqd-step-editor {padding: 10px;}
		.sqd-step-editor p {margin: 0; padding: 0 0 10px;}
		.sqd-step-editor label {display: block; padding: 0 0 10px;}
		.sqd-step-editor input[type=text] {width: 100%; box-sizing: border-box; border: 1px solid silver; padding: 6px; border-radius: 5px;}
	</style>
</head>
<body>
	<div id="designer"></div>

	<div id="result">
		<div class="control">
			<button id="play">Play</button>

			<pre id="logs"></pre>
		</div>

	</div>

	<script>
		let designer;

		function uid() {
			return Math.ceil(Math.random() * 10**16).toString(16);
		}

		function task(type, name, _var, val) {
			return {
				id: uid(),
				componentType: 'task',
				type,
				name,
				properties: {
					var: _var,
					val
				}
			};
		}

		const configuration = {
			toolbox: {
				isHidden: false,
				groups: [
					{
						name: 'Filters',
						steps: [
							task('add', 'Add', 'x', 10),
							task('sub', 'Subtract', 'x', 10),
							task('mul', 'Multiply', 'x', 10),
							task('div', 'Divide', 'x', 10),
							{
								id: '0x0',
								componentType: 'switch',
								type: 'if',
								name: 'If',
								branches: {
									'true': { steps: [] },
									'false': { steps: [] }
								},
								properties: {}
							}
						]
					}
				]
			},

			steps: {
				iconUrlProvider: (componentType, type) => {
					return `./assets/icon-filter.svg`
				},

				validator: (step) => true
			},

			editors: {
				globalEditorProvider: (definition) => {
					const container = document.createElement('span');
					container.innerText = 'Select a step to edit.';
					return container;
				},
				stepEditorProvider: (step) => {
					const container = document.createElement('div');
					container.innerHTML = `<p><label>Name</label> <input type="text" name="name"></p>
						<p><label>Variable</label> <input type="text" name="var"></p>
						<p><label>Value</label> <input type="text" name="val"></p>`;

					const nameInput = container.querySelector('input[name=name]');
					const varInput = container.querySelector('input[name=var]');
					const valInput = container.querySelector('input[name=val]');
					nameInput.value = step.name;
					varInput.value = step.properties['var'];
					valInput.value = step.properties['val'];

					nameInput.addEventListener('change', () => {
						step.name = nameInput.value;
						designer.notifiyDefinitionChanged();
					});
					varInput.addEventListener('change', () => {
						step.properties['var'] = varInput.value;
					});
					valInput.addEventListener('change', () => {
						step.properties['val'] = parseInt(valInput.value, 10);
					});
					return container;
				}
			}
		};

		function executeTask(step, state) {
			const varName = step.properties['var'];
			const value = step.properties['val'];
			if (!state[varName]) {
				state[varName] = 0;
			}
			switch (step.type) {
				case 'add':
					state[varName] += value;
					break;
				case 'sub':
					state[varName] -= value;
					break;
				case 'mul':
					state[varName] *= value;
					break;
				case 'div':
					state[varName] /= value;
					break;
			}
		}

		function printState(state) {
			document.getElementById('logs').innerText = JSON.stringify(state, null, 4);
		}

		function play() {
			if (designer.isReadonly()) {
				return;
			}

			const definition = designer.getDefinition();
			designer.setIsReadonly(true);

			let index = 0;
			const state = {};
			const iv = setInterval(() => {
				if (index === definition.sequence.steps.length) {
					designer.setIsReadonly(false);
					designer.clearSelectedStep();
					clearInterval(iv);
					return;
				}

				const step = definition.sequence.steps[index];
				executeTask(step, state);
				printState(state);
				index++;

				designer.selectStepById(step.id);
			}, 1000);
		}

		const startDefinition = {
			properties: {},
			sequence: {
				steps: [
					task('add', 'Add X', 'x', 10),
					task('mul', 'Mul X', 'x', 10)
				]
			}
		};
		const placeholder = document.getElementById('designer');
		designer = window.sequentialWorkflowDesigner.create(placeholder, startDefinition, configuration);
		document.getElementById('play').addEventListener('click', play);
	</script>
</body>
</html>
